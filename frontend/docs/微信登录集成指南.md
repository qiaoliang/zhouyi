# 微信登录集成指南

## 概述

本文档说明如何在React Native项目中集成微信开放平台SDK，实现APP端微信授权登录功能。

## 前置条件

1. **微信开放平台账号**
   - 注册微信开放平台账号：https://open.weixin.qq.com/
   - 创建移动应用，获取AppID和AppSecret

2. **应用签名和包名**
   - Android: 需要提供应用签名MD5和包名
   - iOS: 需要提供Bundle ID

## Android集成步骤

### 1. 安装依赖

```bash
npm install react-native-wechat-lib --save
```

### 2. 配置android/app/build.gradle

```gradle
android {
    ...
    defaultConfig {
        ...
        // 微信登录配置
        manifestPlaceholders = [
            WX_APP_ID: "你的微信AppID"
        ]
    }
    ...
}

dependencies {
    ...
    implementation 'com.tencent.mm.opensdk:wechat-sdk-android-without-mta:6.7.0'
}
```

### 3. 配置AndroidManifest.xml

在`android/app/src/main/AndroidManifest.xml`中添加：

```xml
<application>
    ...
    <activity
        android:name=".wxapi.WXEntryActivity"
        android:label="@string/app_name"
        android:exported="true"
        />
    ...
</application>
```

### 4. 创建WXEntryActivity

创建文件：`android/app/src/main/java/你的包名/wxapi/WXEntryActivity.java`

```java
package 你的包名.wxapi;

import com.thefinestartist.finestwebview.FinestWebViewActivity;
import com.facebook.react.bridge.ReactApplicationContext;
import com.facebook.react.modules.core.DeviceEventManagerModule;

public class WXEntryActivity extends FinestWebViewActivity implements IWXAPIEventHandler {
    private IWXAPI api;
    private static ReactApplicationContext reactContext;

    public static void init(ReactApplicationContext context) {
        reactContext = context;
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        api = WXAPIFactory.createWXAPI(this, BuildConfig.WX_APP_ID, false);
        api.handleIntent(getIntent(), this);
    }

    @Override
    protected void onNewIntent(Intent intent) {
        super.onNewIntent(intent);
        api.handleIntent(intent, this);
    }

    @Override
    public void onReq(BaseReq baseReq) {
    }

    @Override
    public void onResp(BaseResp resp) {
        if (resp.getType() == ConstantsAPI.COMMAND_SENDMESSAGE_TO_WX) {
            // 处理微信回调
            String result = "";
            switch (resp.errCode) {
                case BaseResp.ErrCode.ERR_OK:
                    result = "成功";
                    break;
                case BaseResp.ErrCode.ERR_USER_CANCEL:
                    result = "取消";
                    break;
                case BaseResp.ErrCode.ERR_AUTH_DENIED:
                    result = "被拒绝";
                    break;
                default:
                    result = "返回";
                    break;
            }
        }
        finish();
    }
}
```

## iOS集成步骤

### 1. 安装依赖

```bash
cd ios
pod install
```

### 2. 配置Info.plist

在`ios/你的项目/Info.plist`中添加：

```xml
<key>CFBundleURLTypes</key>
<array>
  <dict>
    <key>CFBundleURLSchemes</key>
    <array>
      <string>你的微信AppID</string>
    </array>
  </dict>
</array>
<key>LSApplicationQueriesSchemes</key>
<array>
  <string>weixin</string>
  <string>wechat</string>
</array>
```

### 3. 配置AppDelegate

在`ios/你的项目/AppDelegate.m`中添加：

```objective-c
#import <React/RCTLinkingManager.h>
#import "WXApi.h"

- (BOOL)application:(UIApplication *)application
            openURL:(NSURL *)url
            options:(NSDictionary<UIApplicationOpenURLOptionsKey,id> *)options {
  return [WXApi handleOpenURL:url delegate:self] || [RCTLinkingManager application:application openURL:url options:options];
}

- (BOOL)application:(UIApplication *)application
            continueUserActivity:(NSUserActivity *)userActivity
              restorationHandler:(void (^)(NSArray<id<UIUserActivityRestoring>> * _Nullable))restorationHandler {
  return [WXApi handleOpenUniversalLink:userActivity.webpageURL delegate:self];
}
```

## React Native代码实现

### 1. 创建微信登录服务

```typescript
// services/wechat-login.service.ts
import {NativeModules, Platform} from 'react-native';

const {Wechat} = NativeModules;

interface WechatLoginResponse {
  success: boolean;
  code?: string;
  error?: string;
}

export class WechatLoginService {
  /**
   * 初始化微信SDK
   */
  async init(): Promise<boolean> {
    if (Platform.OS === 'ios') {
      return Wechat?.init('你的微信AppID') ?? false;
    }
    // Android自动初始化
    return true;
  }

  /**
   * 发起微信授权登录
   */
  async login(): Promise<WechatLoginResponse> {
    try {
      const scope = 'snsapi_userinfo';
      const state = 'wechat_sdk_demo_test';

      if (Platform.OS === 'android') {
        await Wechat.sendAuthRequest(scope, state);
        // Android需要监听回调事件
        return new Promise((resolve) => {
          DeviceEventEmitter.addListener('WeChatResp', (resp) => {
            if (resp.type === 'SendAuth.Resp') {
              if (resp.errCode === 0) {
                resolve({success: true, code: resp.code});
              } else if (resp.errCode === -2) {
                resolve({success: false, error: '用户取消'});
              } else {
                resolve({success: false, error: '授权失败'});
              }
            }
          });
        });
      } else {
        const resp = await Wechat.sendAuthRequest(scope, state);
        return {success: true, code: resp.code};
      }
    } catch (error: any) {
      return {success: false, error: error.message};
    }
  }

  /**
   * 检查微信是否安装
   */
  async isInstalled(): Promise<boolean> {
    return Wechat?.isWXAppInstalled() ?? false;
  }
}

export const wechatLoginService = new WechatLoginService();
```

### 2. 在登录页面中使用

```typescript
// screens/LoginScreen.tsx
import {wechatLoginService} from '../services/wechat-login.service';
import {authService} from '@zhouyi/shared/services/auth';

/**
 * 微信登录（APP端）
 */
const handleWechatLogin = async () => {
  try {
    // 检查微信是否安装
    const isInstalled = await wechatLoginService.isInstalled();
    if (!isInstalled) {
      Alert.alert('提示', '请先安装微信客户端');
      return;
    }

    // 发起微信登录
    setLoading(true);
    const result = await wechatLoginService.login();

    if (result.success && result.code) {
      // 调用后端接口完成登录
      await authService.loginWithWechatApp({
        code: result.code,
      });

      // 登录成功，导航到主页
      navigation.reset({
        index: 0,
        routes: [{name: 'Main'}],
      });
    } else {
      Alert.alert('提示', result.error || '微信登录失败');
    }
  } catch (error: any) {
    Alert.alert('提示', error.message || '微信登录失败');
  } finally {
    setLoading(false);
  }
};

// 在组件初始化时初始化微信SDK
useEffect(() => {
  wechatLoginService.init();
}, []);
```

## 测试步骤

1. 确保手机上已安装微信客户端
2. 确保应用签名和包名与微信开放平台配置一致
3. 点击"微信登录"按钮
4. 跳转到微信授权页面
5. 授权后返回APP，自动完成登录

## 常见问题

### 1. Android回调不生效
- 检查`WXEntryActivity`的包名是否正确
- 检查`AndroidManifest.xml`中的配置
- 检查应用签名是否与微信开放平台配置一致

### 2. iOS无法跳转微信
- 检查`Info.plist`中的URL Schemes配置
- 检查Bundle ID是否与微信开放平台配置一致
- 检查微信SDK是否正确初始化

### 3. 回调后code为空
- 检查AppID和AppSecret是否正确
- 检查应用是否在微信开放平台审核通过（开发阶段可以添加测试账号）

## 参考资料

- [微信开放平台文档](https://developers.weixin.qq.com/doc/oplatform/Mobile_App/)
- [react-native-wechat-lib](https://github.com/little-snow-fox/react-native-wechat-lib)
- [微信SDK接入指南](https://developers.weixin.qq.com/doc/oplatform/Mobile_App/access_guide/wechat.html)
