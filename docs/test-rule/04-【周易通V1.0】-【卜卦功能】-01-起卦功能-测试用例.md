# 【周易通V1.0】-【卜卦功能】-起卦功能测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| 模块名称 | 卜卦功能 - 起卦功能 |
| 文档版本 | v1.0 |
| 编写日期 | 2026-01-14 |
| 文档状态 | 待评审 |

---

## 金钱课起卦

### 摇铜钱动画起卦

#### 摇铜钱起卦-成功生成卦象 ZYT-DIV-001

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已登录或处于游客模式
2. 网络连接正常
3. 在起卦页面

**测试步骤**：
1. 打开周易通APP首页
2. 点击"金钱课起卦"按钮
3. 进入摇铜钱动画页面
4. 点击"摇铜钱"按钮或摇晃手机
5. 观看铜钱摇动动画
6. 等待第一次掷铜钱结果（初爻）
7. 重复步骤4-6，连续摇6次
8. 查看生成的卦象

**预期结果**：
1. 进入起卦页面，显示铜钱动画界面
2. 点击按钮后显示铜钱摇动动画（3枚铜钱）
3. 每次摇动后显示结果（字/背数量）
4. 初爻到上爻依次生成（从下到上）
5. 6次摇完后显示完整卦象：
   - 主卦名称（如"乾为天"）
   - 主卦符号（如"䷀"）
   - 六爻阴阳属性
   - 变爻标记
6. 卦象数据自动保存至数据库
7. 返回recordId用于后续查询
8. 自动跳转至解卦页面

**备注**：
- 传统金钱课算法：1字2背=少阳，2字1背=少阴，3字=老阳，3背=老阴
- 连续摇6次生成六爻
- 关联需求：PRD-3.3.1

---

#### 摇铜钱起卦-游客用户 ZYT-DIV-002

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户未登录，处于游客模式
2. 游客卜卦次数<2次
3. 网络连接正常

**测试步骤**：
1. 打开周易通APP首页
2. 点击"金钱课起卦"按钮
3. 完成起卦流程（摇6次铜钱）
4. 查看卦象结果

**预期结果**：
1. 游客可以正常起卦
2. 生成卦象成功
3. 记录保存时使用guestId
4. 首页显示"还可体验X次"提示
5. 卦象结果正常展示

**备注**：
- 游客只能体验2次
- 记录保存30天后自动删除（TTL索引）
- 关联需求：PRD-3.2.2

---

#### 摇铜钱起卦-游客超限 ZYT-DIV-003

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 用户未登录，处于游客模式
2. 游客已卜卦2次

**测试步骤**：
1. 打开周易通APP首页
2. 点击"金钱课起卦"按钮
3. 系统检测游客次数已达上限

**预期结果**：
1. 弹窗提示"您已体验2次，请登录后继续使用"
2. 显示登录引导
3. 提供"立即登录"按钮
4. 点击后跳转至登录页面
5. 无法继续起卦

**备注**：
- 游客限制：2次
- 需引导注册登录
- 关联需求：PRD-3.2.2

---

#### 摇铜钱起卦-网络中断 ZYT-DIV-004

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 用户在起卦页面
2. 已摇完前3次铜钱

**测试步骤**：
1. 在摇第4次铜钱时断开网络
2. 点击"摇铜钱"按钮

**预期结果**：
1. 前端显示网络错误提示
2. 提示"网络连接失败，请检查网络后重试"
3. 已摇的前3次结果缓存
4. 提供"重试"按钮
5. 恢复网络后可继续完成剩余摇卦

**备注**：
- 测试弱网环境
- 支持断点续起卦
- 异常处理

---

### 一键起卦

#### 一键起卦-成功生成卦象 ZYT-DIV-005

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已登录或处于游客模式
2. 网络连接正常
3. 在起卦页面

**测试步骤**：
1. 打开周易通APP首页
2. 点击"一键起卦"按钮
3. 等待卦象生成

**预期结果**：
1. 显示加载动画（如"正在起卦..."）
2. 后台快速生成6爻（不显示动画）
3. 2-3秒后显示完整卦象
4. 显示主卦名称和符号
5. 显示六爻阴阳属性
6. 卦象数据保存至数据库
7. 自动跳转至解卦页面

**备注**：
- 快速起卦方式，适合着急用户
- 后台算法与摇铜钱相同
- 关联需求：PRD-3.3.1

---

#### 一键起卦-游客 ZYT-DIV-006

**优先级**：中
**测试类型**：功能

**前置条件**：
1. 游客模式
2. 游客次数<2次

**测试步骤**：
1. 打开APP首页
2. 点击"一键起卦"

**预期结果**：
1. 快速生成卦象
2. 游客次数-1
3. 正常显示结果

**备注**：
- 与摇铜钱共享次数限制

---

### 六爻生成算法

#### 六爻生成-无变爻（静卦） ZYT-DIV-007

**优先级**：中
**测试类型**：功能

**前置条件**：
1. 用户已登录

**测试步骤**：
1. 执行金钱课起卦
2. 观察六爻结果

**预期结果**：
1. 生成6爻，全部为少阳或少阴
2. changingLines为空数组
3. 变卦=主卦（相同）
4. 卦象稳定，提示"此卦无变爻"

**备注**：
- 静卦：无变爻
- 约占6.25%概率（0.5^6）
- 算法验证

---

#### 六爻生成-全部变爻 ZYT-DIV-008

**优先级**：中
**测试类型**：功能

**前置条件**：
1. 用户已登录

**测试步骤**：
1. 执行金钱课起卦
2. 观察六爻结果

**预期结果**：
1. 生成6爻，全部为老阳或老阴
2. changingLines=[1,2,3,4,5,6]
3. 变卦与主卦完全相反
4. 提示"此卦六爻皆动，变化极大"

**备注**：
- 全变爻卦
- 约占3.125%概率
- 特殊卦象

---

#### 六爻生成-单变爻 ZYT-DIV-009

**优先级**：中
**测试类型**：功能

**前置条件**：
1. 用户已登录

**测试步骤**：
1. 执行金钱课起卦
2. 观察六爻结果

**预期结果**：
1. 生成6爻，其中1个为老阳或老阴
2. changingLines数组长度为1
3. 变卦≠主卦
4. 提示"此卦有1个变爻"

**备注**：
- 最常见情况
- 约占46.875%概率

---

#### 六爻生成-多变爻 ZYT-DIV-010

**优先级**：中
**测试类型**：功能

**前置条件**：
1. 用户已登录

**测试步骤**：
1. 执行金钱课起卦
2. 观察六爻结果

**预期结果**：
1. 生成6爻，其中2-5个为老阳或老阴
2. changingLines数组长度2-5
3. 变卦≠主卦
4. 提示"此卦有X个变爻，变化较多"

**备注**：
- 多变爻情况
- 约占43.75%概率

---

### 互卦计算

#### 互卦计算-成功生成 ZYT-DIV-011

**优先级**：中
**测试类型**：功能

**前置条件**：
1. 用户已登录
2. 已完成起卦

**测试步骤**：
1. 执行金钱课起卦
2. 查看卦象详情
3. 找到互卦信息

**预期结果**：
1. 互卦字段不为空
2. 互卦名称正确（二三四爻为下卦，三四五爻为上卦）
3. 互卦符号正确
4. 互卦序号正确（1-64）
5. 在详细解卦中显示互卦分析

**备注**：
- 互卦：取二三四爻为下卦，三四五爻为上卦
- 详细解卦功能使用
- 算法验证

---

### 数据保存

#### 保存卜卦记录-成功 ZYT-DIV-012

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已登录
2. 起卦成功

**测试步骤**：
1. 执行金钱课起卦
2. 起卦完成后检查数据库

**预期结果**：
1. 数据库中创建新记录
2. userId字段正确
3. hexagram字段完整（主卦、变卦、互卦、六爻）
4. interpretation.basic字段完整（卦名、卦辞、爻辞）
5. payment字段为{type:'free', amount:0, status:'unpaid'}
6. createdAt字段自动生成
7. device字段记录平台信息
8. 返回recordId

**备注**：
- 每次起卦必保存
- 支持历史查询
- 数据完整性

---

#### 保存卜卦记录-游客 ZYT-DIV-013

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 游客模式
2. 起卦成功

**测试步骤**：
1. 游客执行金钱课起卦
2. 起卦完成后检查数据库

**预期结果**：
1. 数据库中创建新记录
2. userId字段为空
3. guestId字段有值
4. hexagram字段完整
5. createdAt字段自动生成
6. 30天后自动删除（TTL索引）

**备注**：
- 游客数据不长期保存
- TTL索引自动清理
- 关联需求：PRD-3.6.3

---

### 特殊场景

#### 并发起卦-两个请求 ZYT-DIV-014

**优先级**：低
**测试类型**：异常

**前置条件**：
1. 用户已登录

**测试步骤**：
1. 快速连续点击两次"一键起卦"按钮
2. 观察系统响应

**预期结果**：
1. 生成2条独立的卜卦记录
2. 两个recordId不同
3. 两个卦象可能相同也可能不同
4. 都正常保存至数据库

**备注**：
- 不需要防止重复提交
- 每次起卦都是独立事件
- 低优先级场景

---

#### 卜卦频率限制 ZYT-DIV-015

**优先级**：低
**测试类型**：功能

**前置条件**：
1. 用户已登录

**测试步骤**：
1. 连续执行10次一键起卦
2. 观察系统响应

**预期结果**：
1. 所有起卦都成功
2. 生成10条独立记录
3. 无频率限制

**备注**：
- 正式用户无频率限制
- 会员权益
- 低优先级验证

---

## 附录

### 测试数据

| 数据类型 | 示例值 | 用途 |
|---------|--------|------|
| 正式用户ID | user_001 | 正常起卦测试 |
| 游客ID | guest_xxx_001 | 游客起卦测试 |
| 主卦示例 | 乾为天（䷀） | 卦象验证 |
| 变卦示例 | 坤为地（䷁） | 变卦验证 |
| 互卦示例 | 天风姤（䷫） | 互卦验证 |

### 金钱课算法说明

| 铜钱结果 | 爻的类型 | 阴阳 | 是否变爻 |
|---------|----------|------|----------|
| 1字2背 | 少阳 | 阳 | 否 |
| 2字1背 | 少阴 | 阴 | 否 |
| 3字 | 老阳 | 阳 | 是（变阴） |
| 3背 | 老阴 | 阴 | 是（变阳） |

### 卦象数据结构

```typescript
{
  primary: { name: "乾为天", symbol: "䷀", pinyin: "qian", sequence: 1 },
  lines: [
    { position: 1, yinYang: "yang", changing: false },
    { position: 2, yinYang: "yang", changing: false },
    { position: 3, yinYang: "yang", changing: false },
    { position: 4, yinYang: "yang", changing: false },
    { position: 5, yinYang: "yang", changing: false },
    { position: 6, yinYang: "yang", changing: false }
  ],
  changed: { name: "乾为天", symbol: "䷀", pinyin: "qian", sequence: 1 },
  mutual: { name: "乾为天", symbol: "䷀", pinyin: "qian", sequence: 1 },
  changingLines: []
}
```

### 测试环境要求

| 环境项 | 要求 |
|--------|------|
| 数据库 | MongoDB 4.4+ |
| 网络 | 正常网络、弱网环境 |
| 设备 | iOS/Android/小程序 |
| 游客模式 | 支持未登录测试 |

### 相关文档

- PRD文档：`.taskmaster/docs/prd.md`
- 测试用例组织规则：`docs/test-rule/00-【周易通V1.0】测试用例组织规则.md`
- 卜卦服务：`src/modules/divination/divination.service.ts`
- 卜卦Schema：`src/database/schemas/divination-record.schema.ts`

---

## 更新记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|----------|--------|
| v1.0 | 2026-01-14 | 初始版本，完成15条测试用例设计 | Claude |
