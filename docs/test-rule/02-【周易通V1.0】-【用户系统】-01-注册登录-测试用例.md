# 【周易通V1.0】-【用户系统】-注册登录测试用例

## 文档信息

| 项目 | 内容 |
|------|------|
| 模块名称 | 用户系统 - 注册登录 |
| 文档版本 | v1.0 |
| 编写日期 | 2026-01-14 |
| 文档状态 | 待评审 |

---

## 微信授权登录

### 微信小程序授权登录

#### 首次登录-创建新用户 ZYT-USER-001

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已安装微信APP
2. 周易通小程序已获得微信授权
3. 网络连接正常
4. 该微信openid未注册过账号

**测试步骤**：
1. 打开周易通小程序
2. 点击首页"微信一键登录"按钮
3. 在微信授权弹窗中点击"同意"
4. 等待授权完成

**预期结果**：
1. 小程序调用微信wx.login获取code成功
2. 显示授权提示（获取用户信息）
3. 授权成功后自动返回小程序
4. 首页显示用户默认头像和昵称（微信用户）
5. 自动登录成功，跳转至首页
6. 后台创建新用户记录，保存openId和用户信息
7. 返回accessToken和refreshToken

**备注**：
- 首次登录自动创建用户账号
- 测试数据需使用真实微信openid
- 关联需求：PRD-3.2.1

---

#### 已注册用户-登录成功 ZYT-USER-002

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已安装微信APP
2. 该微信openid已注册过账号
3. 网络连接正常

**测试步骤**：
1. 打开周易通小程序
2. 点击首页"微信一键登录"按钮
3. 在微信授权弹窗中点击"同意"
4. 等待授权完成

**预期结果**：
1. 调用微信wx.login获取code成功
2. 授权成功后自动返回小程序
3. 首页显示用户头像和昵称（与注册时一致）
4. 自动登录成功，跳转至首页
5. 更新用户lastLoginAt时间
6. 返回accessToken和refreshToken

**备注**：
- 已存在用户不重复创建
- 测试数据需使用已注册的微信openid

---

#### code无效-授权失败 ZYT-USER-003

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 用户已安装微信APP
2. 网络连接正常

**测试步骤**：
1. 打开周易通小程序
2. 使用模拟工具拦截请求，将wx.login返回的code替换为无效值（如"invalid_code"）
3. 点击首页"微信一键登录"按钮
4. 等待授权完成

**预期结果**：
1. 后端调用微信API验证code失败
2. 返回错误提示"微信登录失败"
3. 用户停留在登录页面
4. 不创建用户记录

**备注**：
- 测试异常场景
- 需使用抓包工具模拟无效code

---

### 微信APP授权登录

#### 首次登录-创建新用户 ZYT-USER-004

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已安装周易通APP和微信APP
2. 周易通APP已获得微信授权
3. 网络连接正常
4. 该微信openid未注册过账号

**测试步骤**：
1. 打开周易通APP
2. 点击首页"微信一键登录"按钮
3. 跳转至微信APP授权页面
4. 在微信授权页面点击"同意"
5. 等待授权完成并返回APP

**预期结果**：
1. APP成功跳转至微信授权页面
2. 显示授权提示（获取用户信息）
3. 授权成功后自动返回APP
4. 首页显示用户头像和昵称（从微信获取）
5. 自动登录成功，跳转至首页
6. 后台创建新用户记录，保存unionId/openId和用户信息
7. 返回accessToken和refreshToken

**备注**：
- 首次登录自动创建用户账号
- 微信APP登录使用unionId作为唯一标识（如有）
- 关联需求：PRD-3.2.1

---

#### 已注册用户-登录成功 ZYT-USER-005

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已安装周易通APP和微信APP
2. 该微信openid已注册过账号
3. 网络连接正常

**测试步骤**：
1. 打开周易通APP
2. 点击首页"微信一键登录"按钮
3. 跳转至微信APP授权页面
4. 在微信授权页面点击"同意"
5. 等待授权完成并返回APP

**预期结果**：
1. 成功跳转至微信授权页面
2. 授权成功后自动返回APP
3. 首页显示用户头像和昵称（与注册时一致）
4. 自动登录成功，跳转至首页
5. 更新用户lastLoginAt时间
6. 返回accessToken和refreshToken

**备注**：
- 已存在用户不重复创建
- 测试数据需使用已注册的微信openid

---

#### code无效-授权失败 ZYT-USER-006

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 用户已安装周易通APP和微信APP
2. 网络连接正常

**测试步骤**：
1. 打开周易通APP
2. 使用抓包工具拦截请求，将授权返回的code替换为无效值
3. 点击首页"微信一键登录"按钮
4. 等待授权完成

**预期结果**：
1. 后端调用微信API验证code失败
2. 返回错误提示"微信登录失败"
3. 用户停留在登录页面
4. 不创建用户记录

**备注**：
- 测试异常场景
- 需使用抓包工具模拟无效code

---

## 手机验证码登录

### 发送验证码

#### 发送验证码-成功 ZYT-USER-007

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 网络连接正常
2. 短信服务正常

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入有效手机号（如13800138000）
3. 点击"获取验证码"按钮
4. 等待短信接收

**预期结果**：
1. 接口返回success: true
2. 提示"验证码发送成功"
3. 返回expiresAt时间戳
4. 用户在60秒内收到6位数字验证码短信
5. 验证码已存储至Redis，有效期5分钟
6. 按钮进入倒计时状态（60秒）

**备注**：
- 验证码长度6位
- 有效期5分钟（300秒）
- 测试环境可使用测试手机号

---

#### 手机号格式错误-11位非1开头 ZYT-USER-008

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 网络连接正常

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入无效手机号（如23800138000，第二位不是3-9）
3. 点击"获取验证码"按钮

**预期结果**：
1. 接口返回400错误
2. 提示"手机号格式不正确"
3. 不发送短信
4. 不存储验证码

**备注**：
- 中国大陆手机号规则：1开头，第二位3-9，共11位
- 测试无效等价类

---

#### 发送频率限制-60秒内重复发送 ZYT-USER-009

**优先级**：高
**测试类型**：异常

**前置条件**：
1. 网络连接正常
2. 已成功发送过一次验证码

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入有效手机号（13800138000）
3. 点击"获取验证码"按钮，等待发送成功
4. 立即再次点击"获取验证码"按钮（60秒内）

**预期结果**：
1. 第二次点击时接口返回400错误
2. 提示"发送过于频繁，请XX秒后再试"（显示剩余秒数）
3. 不发送第二条短信
4. 按钮保持倒计时状态

**备注**：
- 频率限制：60秒内只能发送1次
- 使用Redis存储发送记录，key为sms:rate:{phoneNumber}
- 关键业务规则，防止短信滥用

---

#### 失败次数限制-超过5次 ZYT-USER-010

**优先级**：高
**测试类型**：异常

**前置条件**：
1. 网络连接正常
2. 该手机号验证失败已达4次

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入手机号（13800138000）
3. 点击"获取验证码"按钮
4. 输入错误验证码，提交
5. 重复步骤3-4，累计5次验证失败

**预期结果**：
1. 第5次验证失败时提示"验证失败次数过多，请1小时后再试"
2. 该手机号被锁定，无法继续验证
3. 锁定时长1小时（3600秒）
4. Redis中sms:attempts:{phoneNumber}值为5，有效期1小时

**备注**：
- 失败次数限制：5次
- 锁定时长：1小时
- 防止暴力破解验证码
- 关键安全规则

---

#### 手机号边界值-10位（格式错误） ZYT-USER-011

**优先级**：中
**测试类型**：边界值

**前置条件**：
1. 网络连接正常

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入10位手机号（如1380013800）
3. 点击"获取验证码"按钮

**预期结果**：
1. 接口返回400错误
2. 提示"手机号格式不正确"
3. 不发送短信

**备注**：
- 边界值测试：小于11位
- 测试边界条件

---

#### 短信服务失败 ZYT-USER-012

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 网络连接正常
2. 短信服务异常（模拟短信服务宕机）

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入有效手机号（13800138000）
3. 点击"获取验证码"按钮
4. 后端短信服务抛出异常

**预期结果**：
1. 接口返回500错误
2. 提示"短信发送失败，请稍后重试"
3. Redis中已存储的验证码被删除
4. 用户可重新发送验证码

**备注**：
- 测试异常处理
- 发送失败需清理已存储的验证码

---

### 验证码登录

#### 验证码登录-首次登录成功 ZYT-USER-013

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 已成功获取验证码
2. 验证码未过期
3. 该手机号未注册过账号

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入手机号（13800138000）
3. 输入收到的6位验证码
4. 点击"登录"按钮

**预期结果**：
1. 接口返回success: true
2. 提示"登录成功"
3. 后台创建新用户记录，保存手机号
4. 返回accessToken、refreshToken、expiresIn
5. 返回用户信息（id、phoneNumber脱敏、nickname、avatar等）
6. 跳转至首页
7. Redis中验证码被删除
8. Redis中失败次数记录被清除

**备注**：
- 首次登录自动创建用户
- 验证码验证成功后立即删除
- 关联需求：PRD-3.2.1

---

#### 验证码错误-5次-账号锁定 ZYT-USER-014

**优先级**：高
**测试类型**：异常

**前置条件**：
1. 已成功获取验证码
2. 验证码未过期

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入手机号（13800138000）和错误验证码
3. 点击"登录"按钮
4. 重复步骤2-3，累计5次输入错误验证码

**预期结果**：
1. 第1-4次错误提示"验证码错误，还剩X次机会"
2. 第5次错误提示"验证失败次数过多，请1小时后再试"
3. Redis中验证码被删除
4. 该手机号被锁定1小时
5. 无法继续验证登录

**备注**：
- 失败次数限制：5次
- 每次失败更新Redis中attempts值
- 关键安全规则，防止暴力破解

---

#### 验证码过期 ZYT-USER-015

**优先级**：高
**测试类型**：异常

**前置条件**：
1. 已成功获取验证码
2. 等待超过5分钟

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入手机号（13800138000）和已过期的验证码
3. 点击"登录"按钮

**预期结果**：
1. 接口返回401错误
2. 提示"验证码已过期"
3. Redis中验证码被删除
4. 需重新获取验证码

**备注**：
- 验证码有效期：5分钟（300秒）
- 过期后立即删除
- 边界值测试场景

---

#### 验证码为空 ZYT-USER-016

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 网络连接正常

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入手机号（13800138000）
3. 验证码输入框留空
4. 点击"登录"按钮

**预期结果**：
1. 前端表单验证拦截
2. 提示"请输入验证码"
3. 不发送登录请求

**备注**：
- 前端表单验证
- 空值校验

---

#### 验证码格式错误 ZYT-USER-017

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 已成功获取验证码

**测试步骤**：
1. 打开周易通APP登录页面
2. 输入手机号（13800138000）
3. 输入包含字母的验证码（如"12345a"）
4. 点击"登录"按钮

**预期结果**：
1. 前端表单验证拦截（或后端验证失败）
2. 提示"验证码格式错误"
3. 登录失败

**备注**：
- 验证码应为6位纯数字
- 格式校验

---

## Token管理

### 刷新Token

#### 刷新Token-成功 ZYT-USER-018

**优先级**：高
**测试类型**：功能

**前置条件**：
1. 用户已登录
2. 持有有效的refreshToken
3. refreshToken未过期（7天内）

**测试步骤**：
1. 用户在APP中操作时，accessToken即将过期
2. APP自动调用刷新Token接口
3. 传递有效的refreshToken

**预期结果**：
1. 接口返回success: true
2. 提示"Token刷新成功"
3. 返回新的accessToken和refreshToken
4. 返回新的expiresIn
5. 返回最新用户信息
6. 用户无感知继续使用APP

**备注**：
- accessToken有效期：15分钟
- refreshToken有效期：7天
- 自动刷新机制对用户透明

---

#### 刷新Token-Token过期 ZYT-USER-019

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 用户已登录
2. refreshToken已过期（超过7天）

**测试步骤**：
1. 用户打开APP
2. refreshToken已过期
3. APP尝试刷新Token

**预期结果**：
1. 接口返回401错误
2. 提示"登录已过期，请重新登录"
3. 跳转至登录页面
4. 清除本地存储的Token

**备注**：
- Token过期需重新登录
- 引导用户重新登录

---

#### 刷新Token-无效Token ZYT-USER-020

**优先级**：中
**测试类型**：异常

**前置条件**：
1. 网络连接正常

**测试步骤**：
1. 用户在APP中操作
2. APP调用刷新Token接口
3. 传递伪造的或篡改过的refreshToken

**预期结果**：
1. 接口返回401错误
2. 提示"无效的Token"
3. 跳转至登录页面
4. 清除本地存储的Token

**备注**：
- JWT签名验证
- 防止Token伪造
- 安全测试场景

---

## 附录

### 测试数据

| 数据类型 | 示例值 | 用途 |
|---------|--------|------|
| 有效手机号 | 13800138000 | 正常登录测试 |
| 无效手机号 | 23800138000 | 格式错误测试 |
| 边界手机号-10位 | 1380013800 | 边界值测试 |
| 边界手机号-12位 | 138001380000 | 边界值测试 |
| 微信openid | o_test_001 | 微信登录测试 |
| 微信unionid | u_test_001 | 微信登录测试 |

### 测试环境要求

| 环境项 | 要求 |
|--------|------|
| 短信服务 | 可用，支持发送验证码 |
| Redis服务 | 可用，用于存储验证码和频率限制 |
| 微信API | 小程序/APP登录接口可用 |
| 网络环境 | WiFi或4G/5G |

### 相关文档

- PRD文档：`.taskmaster/docs/prd.md`
- 测试用例组织规则：`docs/test-rule/00-【周易通V1.0】测试用例组织规则.md`
- 后端API文档：`docs/backend/微信登录API文档.md`

---

## 更新记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|----------|--------|
| v1.0 | 2026-01-14 | 初始版本，完成20条测试用例设计 | Claude |
