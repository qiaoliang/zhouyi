# 周易通APP - 数据库设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2026-01-11 |
| 数据库 | MongoDB |
| 设计阶段 | MVP |

---

## 1. 数据库概述

### 1.1 技术选型

**主数据库**: MongoDB 7.0+

**选择理由**:
- ✅ 灵活的文档模型，适合快速迭代
- ✅ 易于存储复杂的卜卦数据结构
- ✅ 水平扩展能力强
- ✅ JSON格式，与前端无缝对接
- ✅ 适合存储半结构化的易经内容

**备选方案**: PostgreSQL (用于订单和支付，MVP阶段暂不使用)

---

### 1.2 命名规范

```
集合名称: 小写 + 下划线 (users, divination_records)
字段名称: 驼峰命名 (userId, createdAt)
索引名称: 集合_字段_类型 (users_unionId_1)
```

---

## 2. 数据库ER图

```
┌─────────────────┐
│     users       │
│  (用户表)        │
└────────┬────────┘
         │ 1
         │
         │ n
┌────────▼──────────────────────┐
│     divination_records         │
│     (卜卦记录表)                │
├──────────────────────────────┤
│  ┌─────────────────────────┐  │
│  │     orders              │  │
│  │  (订单表)               │  │
│  └─────────────────────────┘  │
└──────────────────────────────┘

┌─────────────────┐
│  hexagrams      │
│ (六十四卦表)     │
└─────────────────┘

┌─────────────────┐
│ learning_progress│
│ (学习进度表)      │
└─────────────────┘

┌─────────────────┐
│  daily_hexagrams│
│  (每日一卦表)    │
└─────────────────┘
```

---

## 3. 集合设计

### 3.1 users (用户表)

存储用户基本信息、会员状态和统计数据

```javascript
{
  _id: ObjectId("..."),

  // 身份标识
  unionId: "wx_union_id_123",           // 微信开放平台UnionID
  openId: "wx_open_id_456",             // 微信小程序OpenID
  phoneNumber: "+8613800138000",        // 手机号 (加密存储)

  // 基本信息
  nickname: "周易爱好者",
  avatar: "https://oss.example.com/avatars/xxx.jpg",
  gender: "male" | "female" | "unknown",

  // 会员信息
  membership: {
    type: "free" | "monthly" | "yearly",
    level: 0 | 1 | 2,                     // 0=免费, 1=月费, 2=年费
    expireAt: ISODate("2026-02-11"),     // 到期时间
    autoRenew: false,                     // 自动续费
    activatedAt: ISODate("2026-01-11")   // 激活时间
  },

  // 统计数据
  stats: {
    divinationCount: 15,                  // 总卜卦次数
    guestUsedCount: 0,                    // 游客已用次数
    learningProgress: 60,                 // 学习进度 %
    lastDivinationAt: ISODate("...")
  },

  // 状态
  isGuest: false,                         // 是否游客
  status: "active" | "suspended" | "deleted",

  // 推送相关
  push: {
    enabled: true,
    dailyHexagram: true,                  // 每日一卦推送
    time: "08:00"
  },

  // 时间戳
  createdAt: ISODate("2026-01-11"),
  updatedAt: ISODate("2026-01-11"),
  lastLoginAt: ISODate("2026-01-11"),
  deletedAt: null                         // 软删除
}
```

#### 索引设计

```javascript
// 主键
_id: 主索引

// 唯一索引
db.users.createIndex({ unionId: 1 }, { unique: true, sparse: true })
db.users.createIndex({ openId: 1 }, { unique: true, sparse: true })
db.users.createIndex({ phoneNumber: 1 }, { unique: true, sparse: true })

// 查询索引
db.users.createIndex({ membership: 1 })
db.users.createIndex({ isGuest: 1 })
db.users.createIndex({ createdAt: -1 })

// 复合索引
db.users.createIndex({ openId: 1, status: 1 })
```

---

### 3.2 divination_records (卜卦记录表)

存储用户的卜卦记录和结果

```javascript
{
  _id: ObjectId("..."),
  userId: ObjectId("..."),               // 用户ID
  guestId: "guest_device_123",           // 游客设备ID (可选)

  // 卦象信息
  hexagram: {
    // 主卦
    primary: {
      name: "乾为天",
      symbol: "䷀",
      pinyin: "qián wéi tiān",
      sequence: 1
    },

    // 六爻 (从下到上: 初爻到上爻)
    lines: [
      { position: 1, yinYang: "yang",  changing: false },
      { position: 2, yinYang: "yang",  changing: false },
      { position: 3, yinYang: "yang",  changing: true  },  // 变爻
      { position: 4, yinYang: "yang",  changing: false },
      { position: 5, yinYang: "yang",  changing: true  },  // 变爻
      { position: 6, yinYang: "yang",  changing: false }
    ],

    // 变卦
    changed: {
      name: "天风姤",
      symbol: "䷫",
      pinyin: "tiān fēng gòu",
      sequence: 44
    },

    // 互卦 (二三四爻为下卦，三四五爻为上卦)
    mutual: {
      name: "乾为天",
      symbol: "䷀",
      pinyin: "qián wéi tiān",
      sequence: 1
    },

    // 变爻位置
    changingLines: [3, 5]
  },

  // 精准解卦信息
  preciseInfo: {
    name: "张三",                         // 姓名
    gender: "male",
    birthDate: ISODate("1990-01-01"),    // 出生日期
    question: "事业发展"                  // 占问事项
  },

  // 解卦结果
  interpretation: {
    basic: {                              // 基础解卦 (免费)
      hexagramName: "乾为天",
      guaci: "元亨利贞...",               // 卦辞原文
      guaciTranslation: "...",           // 卦辞白话
      yaoci: [                            // 爻辞
        {
          position: 1,
          original: "初九：潜龙勿用",
          translation: "龙潜伏在水中，暂时不宜有所作为。"
        },
        // ... 其他爻
      ]
    },

    detailed: {                           // 详细解卦 (付费)
      changingAnalysis: "...",            // 变卦分析
      mutualAnalysis: "...",              // 互卦分析
      timingAnalysis: "...",              // 应期分析
      advice: "..."                       // 综合建议
    },

    precise: "..."                        // 精准解卦 (付费)
  },

  // 支付信息
  payment: {
    type: "free" | "single" | "membership",
    orderId: ObjectId("..."),
    amount: 0,
    status: "unpaid" | "paid" | "refunded"
  },

  // 用户标记
  isFavorite: false,                      // 是否收藏

  // 设备信息
  device: {
    platform: "ios" | "android" | "miniprogram" | "h5",
    model: "iPhone 15 Pro"
  },

  // 时间戳
  createdAt: ISODate("2026-01-11T10:30:00Z"),
  syncAt: ISODate("2026-01-11T10:30:00Z") // 云端同步时间
}
```

#### 索引设计

```javascript
// 主键
_id: 主索引

// 查询索引
db.divination_records.createIndex({ userId: 1, createdAt: -1 })
db.divination_records.createIndex({ guestId: 1, createdAt: -1 })
db.divination_records.createIndex({ "hexagram.primary.sequence": 1 })
db.divination_records.createIndex({ isFavorite: 1 })

// 复合索引
db.divination_records.createIndex({ userId: 1, isFavorite: 1 })
db.divination_records.createIndex({ userId: 1, payment: 1 })
```

---

### 3.3 hexagrams (六十四卦数据表)

存储六十四卦的完整内容

```javascript
{
  _id: ObjectId("..."),

  // 基本信息
  symbol: "䷀",                          // 卦象符号
  name: "乾为天",
  pinyin: "qián wéi tiān",
  sequence: 1,                            // 序号 (1-64)

  // 卦辞
  guaci: {
    original: "乾，元亨利贞。",
    translation: "乾卦象征天，元始、亨通、和谐有利、正固持久。",
    annotation: "..."
  },

  // 彖辞
    original: "大哉乾元，万物资始，乃统天。",
    translation: "...",
    annotation: "..."
  },

  // 象辞
  xiangci: {
    original: "天行健，君子以自强不息。",
    translation: "天道运行刚劲强健，君子应效法天道，力求进步，永不停息。",
    annotation: "..."
  },

  // 六爻
  yaoci: [
    {
      position: 1,
      name: "初九",
      yinYang: "yang",
      original: "初九：潜龙勿用。",
      translation: "龙潜伏在水中，暂时不宜有所作为。",
      xiang: "潜龙勿用，阳在下也。",
      annotation: "..."
    },
    {
      position: 2,
      name: "九二",
      yinYang: "yang",
      original: "九二：见龙在田，利见大人。",
      translation: "龙出现在田野之上，有利于拜见大人。",
      xiang: "见龙在田，德施普也。",
      annotation: "..."
    },
    // ... 其他爻
  ],

  // 用卦 (部分卦有)
  yonggua: {
    original: "用九：见群龙无首，吉。",
    translation: "出现群龙无首的局面，吉利。",
    annotation: "..."
  },

  // 高级分析
  analysis: {
    changing: {                           // 变卦分析模板
      principles: ["...", "..."],
      examples: ["...", "..."]
    },
    mutual: {                             // 互卦分析模板
      principles: ["...", "..."],
      examples: ["...", "..."]
    },
    timing: {                             // 应期分析模板
      principles: ["...", "..."],
      examples: ["...", "..."]
    }
  },

  // 元数据
  metadata: {
    element: "金",                        // 五行
    nature: "健",                         // 卦德
    direction: "西北",                    // 方位
    season: "秋冬",                       // 季节
    trigrams: {
      upper: {
        name: "乾",
        symbol: "☰",
        nature: "天",
        position: "upper"
      },
      lower: {
        name: "乾",
        symbol: "☰",
        nature: "天",
        position: "lower"
      }
    },
    family: "父",                         // 八卦家庭
    body: "首",                           // 对应身体部位
    animal: "马",                         // 对应动物
    color: "大赤色"                       // 对应颜色
  },

  // 关联
  opposites: [12, 33],                    // 相对的卦 (坤、剥)
    [11, 12, 13],                         // 相似的卦
  derived: [44],                          // 所生的卦 (姤)

  // 标签和分类
  tags: ["纯阳卦", "上上卦", "吉"],
  category: {
    nature: "阳",                         // 阳卦/阴卦
    quality: "吉" | "凶" | "平",
    difficulty: "simple" | "complex"
  },

  // 学习相关
  learning: {
    courseId: "hexagram_001",
    order: 1,
    difficulty: 1,                        // 难度 1-5
    readingTime: 5                        // 预计阅读时间 (分钟)
  },

  // 时间戳
  createdAt: ISODate("2026-01-11"),
  updatedAt: ISODate("2026-01-11")
}
```

#### 索引设计

```javascript
// 主键
_id: 主索引

// 唯一索引
db.hexagrams.createIndex({ sequence: 1 }, { unique: true })
db.hexagrams.createIndex({ symbol: 1 }, { unique: true })

// 查询索引
db.hexagrams.createIndex({ name: "text", pinyin: "text" })
db.hexagrams.createIndex({ "metadata.element": 1 })
db.hexagrams.createIndex({ tags: 1 })
```

---

### 3.4 orders (订单表)

存储用户订单和支付信息

```javascript
{
  _id: ObjectId("..."),
  userId: ObjectId("..."),

  // 订单基本信息
  orderNo: "ZY2026011100001",            // 订单号

  // 订单类型
  type: "membership_monthly" | "membership_yearly" | "single_divination",

  // 金额
  amount: 3000,                          // 单位: 分
  paidAmount: 0,
  discountAmount: 0,
  refundAmount: 0,

  // 商品信息
  product: {
    name: "周易通年费会员",
    description: "365天会员权益",
    duration: 12                         // 月数
  },

  // 支付信息
  payment: {
    method: "wechat" | "alipay",
    channel: "app" | "miniprogram" | "h5",
    transactionId: "wx_trans_123",       // 第三方交易号
    prepayId: "wx_prepay_123",           // 预支付ID
    status: "pending" | "paid" | "failed" | "refunded" | "cancelled",
    paidAt: null,
    failedReason: null
  },

  // 会员信息 (仅会员订单)
  membership: {
    type: "yearly",
    duration: 12,
    startAt: ISODate("2026-01-11"),
    endAt: ISODate("2027-01-11")
  },

  // 状态
  status: "created" | "paid" | "cancelled" | "refunded",

  // 退款信息
  refund: {
    amount: 0,
    reason: null,
    refundId: null,
    refundedAt: null
  },

  // 客户端信息
  client: {
    platform: "ios" | "android" | "miniprogram" | "h5",
    ip: "123.45.67.89",
    userAgent: "..."
  },

  // 时间戳
  createdAt: ISODate("2026-01-11T10:00:00Z"),
  paidAt: null,
  expiredAt: ISODate("2026-01-11T10:30:00Z"), // 订单过期时间

  // 备注
  remark: null
}
```

#### 索引设计

```javascript
// 主键
_id: 主索引

// 唯一索引
db.orders.createIndex({ orderNo: 1 }, { unique: true })

// 查询索引
db.orders.createIndex({ userId: 1, createdAt: -1 })
db.orders.createIndex({ payment.transactionId: 1 })
db.orders.createIndex({ status: 1 })
db.orders.createIndex({ type: 1 })
```

---

### 3.5 learning_progress (学习进度表)

存储用户的学习进度和完成记录

```javascript
{
  _id: ObjectId("..."),
  userId: ObjectId("..."),

  // 课程进度
  courses: [
    {
      id: "course_001",
      name: "六十四卦解读方法",
      order: 1,
      completed: true,
      completedAt: ISODate("2026-01-11T10:00:00Z"),
      readingTime: 180,                  // 阅读时长 (秒)
      quiz: {
        score: 100,                      // 测验分数
        passed: true,
        attempts: 1,
        completedAt: ISODate("...")
      }
    },
    {
      id: "course_002",
      name: "如何起卦",
      order: 2,
      completed: false,
      completedAt: null,
      readingTime: 0,
      quiz: null
    }
    // ... 其他课程
  ],

  // 总体进度
  progress: {
    completed: 1,                        // 已完成数
    total: 5,                            // 总数
    percentage: 20,                      // 百分比
    lastCourseId: "course_001",          // 最后学习的课程
    continueAt: ISODate("2026-01-11T10:30:00Z") // 继续学习位置
  },

  // 奖励
  rewards: {
    freeDetailedDivination: {
      available: true,                   // 是否已解锁
      used: false,
      usedAt: null,
      divinationId: null
    }
  },

  // 统计
  stats: {
    totalReadingTime: 180,               // 总阅读时长 (秒)
    totalQuizScore: 100,                 // 总测验分
    averageQuizScore: 100,               // 平均测验分
    quizAttempts: 1                      // 总测验次数
  },

  // 时间戳
  createdAt: ISODate("2026-01-11"),
  updatedAt: ISODate("2026-01-11")
}
```

#### 索引设计

```javascript
// 主键
_id: 主索引

// 唯一索引
db.learning_progress.createIndex({ userId: 1 }, { unique: true })

// 查询索引
db.learning_progress.createIndex({ "progress.percentage": 1 })
```

---

### 3.6 daily_hexagrams (每日一卦表)

存储每日推送的卦象

```javascript
{
  _id: ObjectId("..."),

  // 日期
  date: ISODate("2026-01-11"),           // 推送日期
  year: 2026,
  month: 1,
  day: 11,

  // 卦象信息
  hexagramId: ObjectId("..."),
  hexagram: {
    name: "乾为天",
    symbol: "䷀",
    sequence: 1
  },

  // 推送内容
  content: {
    guaci: "乾，元亨利贞。",
    advice: "今日运势强劲，适合开展新计划和行动...",
    lucky: {
      direction: "西北",
      color: "金色",
      number: 6,
      time: "辰时"
    }
  },

  // 名言
  quote: {
    text: "天行健，君子以自强不息。",
    source: "易经·乾卦"
  },

  // 统计
  stats: {
    views: 0,                            // 查看次数
    shares: 0,                           // 分享次数
    likes: 0                             // 点赞次数
  },

  // 时间戳
  createdAt: ISODate("2026-01-10T20:00:00Z"), // 前一天生成
  pushScheduledAt: ISODate("2026-01-11T08:00:00Z")
}
```

#### 索引设计

```javascript
// 主键
_id: 主索引

// 唯一索引
db.daily_hexagrams.createIndex({ date: 1 }, { unique: true })

// 查询索引
db.daily_hexagrams.createIndex({ year: 1, month: 1, day: 1 })
```

---

### 3.7 push_notifications (推送通知表)

存储推送通知记录

```javascript
{
  _id: ObjectId("..."),
  userId: ObjectId("..."),

  // 通知类型
  type: "daily_hexagram" | "membership_expiry" | "promotional",

  // 通知内容
  title: "今日卦象：乾为天",
  content: "乾，元亨利贞。今日运势强劲...",
  data: { ... },                         // 额外数据

  // 推送状态
  status: "pending" | "sent" | "failed" | "opened",

  // 推送渠道
  channels: {
    ios: { sent: false, token: "..." },
    android: { sent: false, token: "..." },
    miniprogram: { sent: false, openId: "..." }
  },

  // 时间戳
  scheduledAt: ISODate("2026-01-11T08:00:00Z"),
  sentAt: null,
  openedAt: null,
  createdAt: ISODate("2026-01-11T00:00:00Z")
}
```

---

### 3.8 operation_logs (操作日志表)

存储用户操作日志，用于数据分析

```javascript
{
  _id: ObjectId("..."),
  userId: ObjectId("..."),
  guestId: "guest_123",

  // 操作信息
  action: "divination" | "payment" | "learning" | "login",
  module: string,

  // 详细信息
  details: {
    // 根据action不同，存储不同信息
  },

  // 设备信息
  device: {
    platform: "ios",
    model: "iPhone 15 Pro",
    osVersion: "17.0"
  },

  createdAt: ISODate("2026-01-11T10:30:00Z")
}
```

---

## 4. 数据关系图

```
users (1) ───────────── (n) divination_records
  │                           │
  │                           │
  │                      (1) orders
  │
  │
  └────────────── (1) learning_progress


hexagrams (1) ────────── (n) divination_records
  │
  │
  └────────────── (1) daily_hexagrams


users (1) ───────────── (n) orders
users (1) ───────────── (n) push_notifications
```

---

## 5. 数据迁移策略

### 5.1 初始数据

```javascript
// 六十四卦种子数据
db.hexagrams.insertMany([
  { sequence: 1, name: "乾为天", symbol: "䷀", ... },
  { sequence: 2, name: "坤为地", symbol: "䷁", ... },
  // ... 共64条
]);

// 易经名言库
db.quotes.insertMany([...]);

// 课程内容
db.courses.insertMany([...]);
```

### 5.2 数据备份

```bash
# MongoDB 备份
mongodump --uri="mongodb://localhost:27017/zhouyi" --out=/backup/

# 定时备份 (cron)
0 2 * * * mongodump --uri="..." --out=/backup/$(date +\%Y\%m\%d)/
```

---

## 6. 性能优化

### 6.1 分片策略 (MVP后考虑)

```
# 按用户ID分片
sh.shardCollection("zhouyi.users", { _id: "hashed" })
sh.shardCollection("zhouyi.divination_records", { userId: 1 })

# 按时间分片
sh.shardCollection("zhouyi.operation_logs", { createdAt: 1 })
```

### 6.2 TTL索引 (自动过期)

```javascript
// 游客数据30天后删除
db.divination_records.createIndex(
  { createdAt: 1 },
  { expireAfterSeconds: 2592000, partialFilterExpression: { guestId: { $exists: true } } }
)

// 操作日志90天后删除
db.operation_logs.createIndex(
  { createdAt: 1 },
  { expireAfterSeconds: 7776000 }
)
```

---

## 7. 数据安全

### 7.1 敏感数据加密

```javascript
// 手机号加密
const crypto = require('crypto');
function encryptPhone(phone) {
  const algorithm = 'aes-256-cbc';
  const key = process.env.ENCRYPT_KEY;
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(algorithm, key, iv);
  let encrypted = cipher.update(phone, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return iv.toString('hex') + ':' + encrypted;
}
```

### 7.2 备份策略

- 每天凌晨2点全量备份
- 每小时增量备份
- 备份保留30天
- 异地备份 (OSS)

---

**文档编写**: Claude
**最后更新**: 2026-01-11
**适用版本**: MongoDB 7.0+
