# 周易通APP - 后端技术栈与架构设计

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2026-01-11 |
| 适用阶段 | MVP |

---

## 1. 后端技术栈选型

### 1.1 运行时和语言

#### 选择: Node.js + TypeScript

**理由**:
- ✅ 与前端技术栈统一，降低学习成本
- ✅ 异步非阻塞I/O，适合高并发场景
- ✅ npm生态丰富，第三方库完善
- ✅ TypeScript提供类型安全
- ✅ 团队技能复用

**版本选择**:
- Node.js: 20.x LTS
- TypeScript: 5.x

---

### 1.2 Web框架对比

| 框架 | 优势 | 劣势 | 推荐度 |
|------|------|------|--------|
| **Express.js** | 简单灵活、生态成熟 | 缺少约定、需要手动配置 | ⭐⭐⭐⭐ |
| **Nest.js** | 企业级架构、TypeScript原生支持、装饰器 | 学习曲线陡峭 | ⭐⭐⭐⭐⭐ |
| **Koa.js** | 轻量现代、中间件优雅 | 生态不如Express | ⭐⭐⭐ |

#### 最终推荐: **Nest.js**

**理由**:
- ✅ TypeScript原生支持
- ✅ 模块化架构，便于组织代码
- ✅ 内置依赖注入
- ✅ 完善的装饰器和元数据
- ✅ 类似Angular架构，学习曲线平滑
- ✅ 适合中大型项目
- ✅ 测试友好

---

### 1.3 数据库选型

#### 主数据库: MongoDB

**理由**:
- ✅ 灵活的文档模型，适合快速迭代
- ✅ 易于存储复杂的卜卦数据结构
- ✅ 水平扩展能力强
- ✅ JSON原生支持，与前端数据格式一致
- ✅ 适合存储用户行为日志

**使用场景**:
- 用户数据和会话
- 卜卦历史记录
- 学习进度
- 每日一卦数据
- 六十四卦内容数据

---

#### 关系型数据库: PostgreSQL (可选)

**理由**:
- ✅ 适合结构化数据
- ✅ ACID事务保证
- ✅ 适合订单和支付数据

**使用场景**:
- 订单记录
- 支付流水
- 会员订阅记录

**MVP阶段建议**: 只使用MongoDB，简化架构

---

### 1.4 缓存方案

#### 选择: Redis

**用途**:
- 用户会话管理
- API响应缓存
- 热点数据缓存（每日一卦）
- 限流和防刷
- 分布式锁

**部署方式**:
- 开发环境: Docker
- 生产环境: 阿里云Redis / 腾讯云Redis

---

### 1.5 文件存储

#### 选择: 云服务OSS

**选项**:
- 阿里云OSS
- 腾讯云COS
- AWS S3

**推荐**: 阿里云OSS（国内访问快）

**存储内容**:
- 用户头像
- 课程配图
- 卦象图示
- 宣传图片

---

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                               │
├─────────────────────────────────────────────────────────────┤
│  React Native APP  │  Taro小程序  │  React H5               │
└─────────────────────┬───────────────┬───────────────────────┘
                      │               │
                      ▼               ▼
              ┌─────────────────────────────┐
              │       CDN / 负载均衡          │
              └──────────────┬──────────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
              ▼                             ▼
┌─────────────────────┐         ┌─────────────────────┐
│   API Gateway       │         │    WebSocket服务     │
│   (Nginx/Kong)      │         │   (推送/实时通信)     │
└──────────┬──────────┘         └─────────────────────┘
           │
           ▼
┌───────────────────────────────────────────────────┐
│               应用服务层 (Nest.js)                 │
├───────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 用户服务  │  │ 卜卦服务  │  │ 内容服务  │        │
│  └──────────┘  └──────────┘  └──────────┘        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 支付服务  │  │ 学习服务  │  │ 推送服务  │        │
│  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────┬─────────────────────────────┘
                      │
      ┌───────────────┼───────────────┐
      │               │               │
      ▼               ▼               ▼
┌───────────┐  ┌───────────┐  ┌───────────┐
│  MongoDB  │  │  Redis    │  │    OSS    │
│  (主数据库)│  │  (缓存)    │  │  (文件)   │
└───────────┘  └───────────┘  └───────────┘
                      │
              ┌───────┴────────┐
              │                │
              ▼                ▼
     ┌──────────────┐  ┌──────────────┐
     │ 第三方服务集成 │  │  消息队列    │
     │ (微信/支付/短信)│  │ (可选)      │
     └──────────────┘  └──────────────┘
```

---

### 2.2 服务模块划分

#### 用户服务 (User Service)
- 注册登录
- 微信授权
- 手机验证
- 游客模式
- 个人信息管理
- 会员管理

#### 卜卦服务 (Divination Service)
- 金钱课起卦
- 卦象生成
- 基础解卦
- 详细解卦
- 精准解卦
- 历史记录

#### 内容服务 (Content Service)
- 六十四卦数据
- 课程内容
- 每日一卦
- 易经名言

#### 支付服务 (Payment Service)
- 微信支付
- 支付宝支付
- 订单管理
- 支付回调
- 退款处理

#### 学习服务 (Learning Service)
- 学习进度
- 课程管理
- 测验功能
- 完成奖励

#### 推送服务 (Push Service)
- 每日一卦推送
- 会员到期提醒
- 营销推送

---

### 2.3 API设计规范

#### RESTful API设计

```
GET    /api/v1/users              # 获取用户列表
GET    /api/v1/users/:id          # 获取用户详情
POST   /api/v1/users              # 创建用户
PUT    /api/v1/users/:id          # 更新用户
DELETE /api/v1/users/:id          # 删除用户

POST   /api/v1/divination         # 起卦
GET    /api/v1/divination/:id     # 获取解卦结果
GET    /api/v1/divination/history # 历史记录

POST   /api/v1/payment/order      # 创建订单
GET    /api/v1/payment/order/:id  # 订单详情
POST   /api/v1/payment/callback   # 支付回调

GET    /api/v1/learning/progress  # 学习进度
POST   /api/v1/learning/complete  # 完成课程
```

#### 统一响应格式

```typescript
// 成功响应
{
  "success": true,
  "data": { ... },
  "message": "操作成功",
  "timestamp": 1704960000000
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "用户不存在",
    "details": { ... }
  },
  "timestamp": 1704960000000
}

// 分页响应
{
  "success": true,
  "data": {
    "items": [ ... ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

---

### 2.4 认证授权方案

#### JWT (JSON Web Token)

```typescript
// Access Token (短期，15分钟)
{
  "userId": "123456",
  "type": "access",
  "exp": 1704960900
}

// Refresh Token (长期，7天)
{
  "userId": "123456",
  "type": "refresh",
  "exp": 1705564800
}
```

#### 游客模式处理

- 生成临时游客ID
- 使用设备指纹标识
- 限制功能访问
- 2次后强制引导注册

---

### 2.5 数据同步策略

#### 多端同步

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   APP端     │     │  小程序端    │     │    H5端     │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                    │                    │
       └────────────────────┼────────────────────┘
                            │
                            ▼
                   ┌─────────────────┐
                   │   云端同步服务    │
                   └────────┬─────────┘
                            │
                            ▼
                   ┌─────────────────┐
                   │     MongoDB     │
                   └─────────────────┘

同步策略:
1. 实时同步: WebSocket (在线状态、学习进度)
2. 延迟同步: REST API (卜卦历史、收藏)
3. 冲突解决: 时间戳 + 版本号
```

---

## 3. 数据模型设计

### 3.1 用户模型

```typescript
interface User {
  _id: ObjectId;
  unionId: string;           // 微信开放平台唯一标识
  openId: string;            // 微信小程序OpenID
  phoneNumber: string;       // 手机号
  nickname: string;          // 昵称
  avatar: string;            // 头像URL
  membership: {
    type: 'free' | 'monthly' | 'yearly';
    expireAt: Date;
    autoRenew: boolean;
  };
  stats: {
    divinationCount: number;    // 卜卦次数
    learningProgress: number;   // 学习进度百分比
    guestUsedCount: number;     // 游客已用次数
  };
  isGuest: boolean;
  createdAt: Date;
  updatedAt: Date;
  lastLoginAt: Date;
  deletedAt: Date | null;      // 软删除
}
```

### 3.2 卜卦记录模型

```typescript
interface DivinationRecord {
  _id: ObjectId;
  userId: ObjectId;
  guestId?: string;            // 游客ID

  // 卦象信息
  hexagram: {
    primary: string;          // 主卦 (如 "乾为天")
    primarySymbol: string;    // 主卦符号 (如 "䷀")
    changingLines: number[];  // 变爻位置 [1,3,5]
    changed: string;          // 变卦
    changedSymbol: string;    // 变卦符号
    mutual: string;           // 互卦
    mutualSymbol: string;     // 互卦符号
  };

  // 精准解卦信息
  preciseInfo?: {
    name: string;             // 姓名
    gender: 'male' | 'female';
    birthDate: Date;          // 出生日期
    question: string;         // 占问事项
  };

  // 解卦结果
  interpretation: {
    basic: string;            // 基础解卦
    detailed?: string;        // 详细解卦 (付费)
    precise?: string;         // 精准解卦 (付费)
  };

  // 支付信息
  payment?: {
    type: 'free' | 'single' | 'membership';
    orderId: ObjectId;
    amount: number;
  };

  createdAt: Date;
  syncAt: Date;              // 同步时间
}
```

### 3.3 六十四卦数据模型

```typescript
interface HexagramData {
  _id: ObjectId;
  symbol: string;            // 卦象符号 (䷀)
  name: string;              // 卦名 (乾为天)
  pinyin: string;            // 拼音 (qián wéi tiān)
  sequence: number;          // 序号 (1-64)

  // 卦辞
  guaci: {
    original: string;        // 原文
    translation: string;     // 白话解释
  };

  // 爻辞
  yaoci: {
    position: number;        // 爻位 (1-6)
    yinYang: 'yin' | 'yang'; // 阴阳
    original: string;        // 原文
    translation: string;     // 白话解释
  }[];

  // 高级分析
  analysis?: {
    changing: string;        // 变卦分析
    mutual: string;          // 互卦分析
    timing: string;          // 应期分析
  };

  metadata: {
    element: string;         // 五行
    nature: string;          // 卦德
    trigrams: {              // 经卦
      upper: string;         // 上卦
      lower: string;         // 下卦
    };
  };

  tags: string[];            // 标签
  related: ObjectId[];       // 相关卦象
}
```

### 3.4 订单模型

```typescript
interface Order {
  _id: ObjectId;
  userId: ObjectId;
  orderNo: string;           // 订单号

  type: 'membership_monthly' | 'membership_yearly' | 'single_divination';

  amount: number;
  paidAmount: number;

  payment: {
    method: 'wechat' | 'alipay';
    transactionId: string;   // 第三方交易号
    status: 'pending' | 'paid' | 'failed' | 'refunded';
    paidAt: Date | null;
  };

  membership?: {
    type: 'monthly' | 'yearly';
    duration: number;        // 月数
    startAt: Date;
    endAt: Date;
  };

  status: 'created' | 'paid' | 'cancelled' | 'refunded';
  createdAt: Date;
  paidAt: Date | null;
}
```

### 3.5 学习进度模型

```typescript
interface LearningProgress {
  _id: ObjectId;
  userId: ObjectId;

  // 课程进度
  courses: {
    id: string;
    name: string;
    completed: boolean;
    completedAt: Date | null;
    quizScore?: number;      // 测验分数
  }[];

  // 总体进度
  progress: {
    completed: number;       // 已完成数
    total: number;           // 总数
    percentage: number;      // 百分比
  };

  // 奖励
  rewards: {
    freeDetailedDivination: {
      available: boolean;
      used: boolean;
      usedAt: Date | null;
    };
  };

  updatedAt: Date;
}
```

---

## 4. 技术实现

### 4.1 Nest.js 项目结构

```
src/
├── main.ts                    # 应用入口
├── app.module.ts              # 根模块
│
├── common/                    # 公共模块
│   ├── decorators/           # 装饰器
│   ├── filters/              # 异常过滤器
│   ├── guards/               # 守卫
│   ├── interceptors/         # 拦截器
│   ├── pipes/                # 管道
│   └── utils/                # 工具函数
│
├── config/                    # 配置
│   ├── database.config.ts
│   ├── redis.config.ts
│   └── app.config.ts
│
├── modules/                   # 业务模块
│   ├── user/                 # 用户模块
│   ├── divination/           # 卜卦模块
│   ├── content/              # 内容模块
│   ├── payment/              # 支付模块
│   ├── learning/             # 学习模块
│   └── push/                 # 推送模块
│
├── database/                  # 数据库
│   ├── schemas/              # Mongoose Schemas
│   └── repositories/         # 数据访问层
│
├── services/                  # 第三方服务集成
│   ├── wechat/
│   ├── alipay/
│   ├── sms/
│   └── oss/
│
└── jobs/                      # 定时任务
    ├── daily-hexagram.job.ts
    └── membership-check.job.ts
```

### 4.2 核心依赖

```json
{
  "dependencies": {
    "@nestjs/common": "^10.0.0",
    "@nestjs/core": "^10.0.0",
    "@nestjs/platform-express": "^10.0.0",
    "@nestjs/config": "^3.0.0",
    "@nestjs/jwt": "^10.0.0",
    "@nestjs/passport": "^10.0.0",
    "@nestjs/mongoose": "^10.0.0",
    "@nestjs/schedule": "^4.0.0",
    "@nestjs/websockets": "^10.0.0",
    "passport": "^0.6.0",
    "passport-jwt": "^4.0.0",
    "mongoose": "^8.0.0",
    "redis": "^4.6.0",
    "class-validator": "^0.14.0",
    "class-transformer": "^0.5.1",
    "axios": "^1.6.0",
    "bcrypt": "^5.1.1"
  }
}
```

### 4.3 环境配置

```typescript
// config/app.config.ts
export default registerAs('app', () => ({
  port: parseInt(process.env.PORT, 10) || 3000,
  nodeEnv: process.env.NODE_ENV || 'development',
  apiPrefix: 'api/v1',
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: '15m',
    refreshExpiresIn: '7d',
  },
  cors: {
    origin: process.env.CORS_ORIGIN?.split(',') || '*',
  },
}));
```

---

## 5. 部署方案

### 5.1 云服务商选择

**推荐**: 阿里云

| 服务 | 选型 | 说明 |
|------|------|------|
| 计算 | ECS / Serverless | 应用服务器 |
| 数据库 | MongoDB 副本集 | 主数据库 |
| 缓存 | Redis | 缓存服务 |
| 存储 | OSS | 文件存储 |
| CDN | CDN | 静态资源加速 |
| 负载均衡 | SLB | 流量分发 |

### 5.2 容器化部署

```dockerfile
# Dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["node", "dist/main"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  api:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - mongo
      - redis

  mongo:
    image: mongo:7
    volumes:
      - mongo-data:/data/db

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data

volumes:
  mongo-data:
  redis-data:
```

---

## 6. 性能优化

### 6.1 缓存策略

```typescript
// 热点数据缓存
- 每日一卦 (TTL: 24小时)
- 六十四卦数据 (TTL: 永久)
- 用户信息 (TTL: 1小时)
- API响应 (TTL: 5分钟)
```

### 6.2 数据库优化

```javascript
// 索引设计
db.users.createIndex({ unionId: 1 }, { unique: true });
db.users.createIndex({ openId: 1 });
db.divination_records.createIndex({ userId: 1, createdAt: -1 });
db.divination_records.createIndex({ guestId: 1, createdAt: -1 });
db.orders.createIndex({ userId: 1, createdAt: -1 });
db.orders.createIndex({ orderNo: 1 }, { unique: true });
```

### 6.3 接口限流

```typescript
// 速率限制策略
- 未登录用户: 10次/分钟
- 已登录用户: 60次/分钟
- VIP用户: 不限流
```

---

## 7. 安全措施

### 7.1 数据安全

- ✅ 敏感数据加密存储 (手机号、身份证)
- ✅ HTTPS强制加密传输
- ✅ JWT令牌签名验证
- ✅ SQL/NoSQL注入防护
- ✅ XSS攻击防护

### 7.2 接口安全

```typescript
// 安全措施
1. 请求签名验证
2. 时间戳防重放
3. IP白名单
4. 接口访问频率限制
5. 敏感操作二次验证
```

---

## 8. 监控和日志

### 8.1 日志管理

```typescript
// 日志级别
- ERROR: 错误日志
- WARN: 警告日志
- INFO: 重要操作日志
- DEBUG: 调试日志

// 日志内容
- 请求日志
- 错误日志
- 性能日志
- 业务日志
```

### 8.2 监控指标

```typescript
// 关键指标
- API响应时间
- 错误率
- 并发用户数
- 数据库连接数
- Redis命中率
- 服务器资源使用率
```

---

**文档编写**: Claude
**最后更新**: 2026-01-11
**适用版本**: Nest.js 10.x, Node.js 20.x
