# 周易通APP - 开发规范文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2026-01-11 |
| 适用范围 | 全团队 |

---

## 1. 代码规范

### 1.1 命名规范

#### 文件命名

```
React组件: PascalCase
  UserProfile.tsx
  DivinationRecord.tsx

工具函数: camelCase
  formatDate.ts
  validatePhone.ts

常量文件: camelCase.constants.ts
  api.constants.ts
  hexagram.constants.ts

类型定义: camelCase.types.ts
  user.types.ts
  divination.types.ts

样式文件: camelCase.styles.ts
  UserProfile.styles.ts
```

#### 变量命名

```typescript
// 变量和函数: camelCase
const userName = '张三';
const getUserInfo = () => {};

// 常量: UPPER_SNAKE_CASE
const API_BASE_URL = 'https://api.example.com';
const MAX_RETRY_COUNT = 3;

// 类和接口: PascalCase
class UserService {}
interface UserProfile {}

// 类型别名: PascalCase
type UserId = string;

// 枚举: PascalCase + camelCase值
enum MembershipType {
  Free = 'free',
  Monthly = 'monthly',
  Yearly = 'yearly'
}

// 布尔值: is/has/can前缀
const isActive = true;
const hasPermission = false;
const canEdit = true;
```

#### 组件命名

```typescript
// 组件文件名与组件名一致
// UserProfile.tsx
export const UserProfile: React.FC<Props> = () => {
  return <div>...</div>;
};

// HOC使用with前缀
export const withAuth = (Component: React.ComponentType) => {
  return (props) => <Component {...props} />;
};

// 自定义Hook使用use前缀
export const useUserInfo = () => {
  const [user, setUser] = useState(null);
  return { user };
};
```

---

### 1.2 TypeScript规范

#### 类型定义

```typescript
// ✅ 推荐: 使用interface定义对象类型
interface UserProfile {
  id: string;
  name: string;
  age: number;
  membership: MembershipType;
}

// ✅ 推荐: 使用type定义联合类型
type Status = 'pending' | 'success' | 'error';
type UserId = string;

// ❌ 避免: 使用any
const data: any = fetchData();

// ✅ 推荐: 使用unknown或具体类型
const data: unknown = fetchData();
// 或
interface ApiResult {
  data: UserData;
  message: string;
}
const result: ApiResult = fetchData();
```

#### 类型导出

```typescript
// user.types.ts
export interface User {
  id: string;
  name: string;
}

export type UserCreateInput = Omit<User, 'id'>;
export type UserUpdateInput = Partial<UserCreateInput>;

export enum UserStatus {
  Active = 'active',
  Inactive = 'inactive'
}
```

#### 泛型使用

```typescript
// ✅ 推荐: 使用有意义的泛型名称
function findByKey<T>(items: T[], key: keyof T, value: unknown): T | undefined {
  return items.find(item => item[key] === value);
}

// ✅ 推荐: 泛型约束
interface Lengthwise {
  length: number;
}

function logLength<T extends Lengthwise>(arg: T): void {
  console.log(arg.length);
}
```

---

### 1.3 React规范

#### 组件结构

```typescript
// ✅ 推荐: 组件结构
import { useState, useEffect } from 'react';
import { View, Text } from 'react-native';
import { useNavigation } from '@react-navigation/native';

// 1. 类型定义
interface Props {
  userId: string;
  onSuccess?: () => void;
}

// 2. 组件定义
export const UserProfile: React.FC<Props> = ({ userId, onSuccess }) => {
  // 3. Hooks (按顺序: useState -> useReducer -> useContext -> useCustomHooks)
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const navigation = useNavigation();

  // 4. useEffect
  useEffect(() => {
    fetchUser(userId).then(data => {
      setUser(data);
      setLoading(false);
    });
  }, [userId]);

  // 5. 事件处理函数
  const handleEdit = () => {
    navigation.navigate('EditUser', { userId });
  };

  // 6. 渲染函数
  if (loading) {
    return <LoadingSpinner />;
  }

  // 7. 返回JSX
  return (
    <View>
      <Text>{user?.name}</Text>
      <Button onPress={handleEdit} title="编辑" />
    </View>
  );
};

// 8. 默认导出 (可选)
export default UserProfile;
```

#### Hooks规则

```typescript
// ✅ 正确: Hooks在最顶层调用
function MyComponent() {
  const [count, setCount] = useState(0);
  useEffect(() => {}, []);
  return <div>{count}</div>;
}

// ❌ 错误: 在条件语句中使用
function BadComponent() {
  if (condition) {
    const [count, setCount] = useState(0); // 错误!
  }
}

// ❌ 错误: 在循环中使用
function BadComponent() {
  for (let i = 0; i < 10; i++) {
    useEffect(() => {}, []); // 错误!
  }
}
```

#### Props解构

```typescript
// ✅ 推荐: 直接解构props
export const Button: React.FC<{
  title: string;
  onPress: () => void;
  disabled?: boolean;
}> = ({ title, onPress, disabled = false }) => {
  return <button onClick={onPress} disabled={disabled}>{title}</button>;
};

// ✅ 推荐: 提取Props类型
interface ButtonProps {
  title: string;
  onPress: () => void;
  disabled?: boolean;
}
export const Button: React.FC<ButtonProps> = ({ title, onPress, disabled = false }) => {
  return <button onClick={onPress} disabled={disabled}>{title}</button>;
};
```

---

### 1.4 样式规范

#### Styled Components风格

```typescript
// ✅ 推荐: 使用Styled Components
import styled from 'styled-components/native';

const Container = styled.View`
  flex: 1;
  padding: 20px;
  background-color: ${props => props.theme.colors.background};
`;

const Title = styled.Text`
  font-size: 24px;
  font-weight: bold;
  color: ${props => props.theme.colors.text};
`;

export const ProfileScreen: React.FC = () => {
  return (
    <Container>
      <Title>用户资料</Title>
    </Container>
  );
};
```

#### StyleSheet风格 (React Native)

```typescript
// ✅ 推荐: 使用StyleSheet.create
import { StyleSheet } from 'react-native';

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 20,
    backgroundColor: '#F5F5F5',
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#333333',
  },
});

export const ProfileScreen: React.FC = () => {
  return (
    <View style={styles.container}>
      <Text style={styles.title}>用户资料</Text>
    </View>
  );
};
```

---

## 2. Git规范

### 2.1 分支策略

```
main          # 主分支，生产环境代码
  ├── develop # 开发分支，集成开发内容
      ├── feature/*  # 功能分支
      ├── bugfix/*   # 修复分支
      └── hotfix/*   # 紧急修复分支
```

#### 分支命名

```
feature/用户登录功能
feature/卜卦功能
feature/支付集成

bugfix/修复卜卦动画卡顿
bugfix/修复会员过期判断

hotfix/紧急修复支付漏洞
hotfix/修复线上崩溃问题
```

---

### 2.2 提交信息规范

使用 Conventional Commits 规范:

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type类型

```
feat:     新功能
fix:      修复bug
docs:     文档变更
style:    代码格式调整(不影响功能)
refactor: 重构(既不是新功能也不是修复)
perf:     性能优化
test:     测试相关
chore:    构建过程或辅助工具的变动
revert:   回滚之前的提交
```

#### 示例

```
# 简单提交
feat(用户): 添加微信登录功能

# 带说明的提交
fix(卜卦): 修复金钱课起卦动画卡顿问题

问题: 摇铜钱动画在第3次后出现卡顿
原因: 动画状态未正确重置
解决: 在每次起卦前重置动画状态

# 带破坏性变更的提交
feat(会员): 重构会员系统

BREAKING CHANGE: 会员等级从三级改为两级

用户会员等级从原来的免费/月费/年费三级
简化为免费/付费两级，已付费用户统一为付费会员

Closes #123
```

---

### 2.3 提交最佳实践

```bash
# ✅ 推荐: 提交前拉取最新代码
git pull origin develop
git add .
git commit -m "feat: 添加新功能"
git push origin feature/新功能

# ✅ 推荐: 使用.gitignore忽略不需要的文件
node_modules/
dist/
.env

# ✅ 推荐: 频繁提交，小步快跑
# 每完成一个小功能就提交一次

# ❌ 避免: 大量的文件一次性提交
# 应该拆分成多个逻辑相关的提交

# ❌ 避免: 提交调试代码
console.log();
debugger;
```

---

## 3. 代码审查规范

### 3.1 审查清单

#### 功能性

- [ ] 代码是否实现了需求文档中的功能
- [ ] 是否处理了边界情况和错误情况
- [ ] 是否有明显的bug

#### 代码质量

- [ ] 代码是否易于理解
- [ ] 是否有重复代码
- [ ] 变量和函数命名是否清晰
- [ ] 是否有必要的注释

#### 性能

- [ ] 是否有不必要的重渲染
- [ ] 是否有内存泄漏风险
- [ ] 是否正确使用了缓存

#### 安全

- [ ] 是否有XSS风险
- [ ] 敏感信息是否正确处理
- [ ] 用户输入是否正确验证

#### 测试

- [ ] 是否有单元测试
- [ ] 测试覆盖率是否足够
- [ ] 是否测试了边界情况

---

### 3.2 审查流程

```
1. 开发者提交Pull Request
2. 系统自动运行CI检查
   - ESLint检查
   - 单元测试
   - 构建检查
3. 至少一名审查者审查代码
4. 提出修改意见或批准
5. 开发者修改意见(如有)
6. 审查通过后合并
```

---

### 3.3 审查意见示例

```markdown
# 代码审查意见

## 需要修改

### 1. 性能问题
`UserProfile.tsx` 第25行:
建议使用 `useMemo` 缓存计算结果，避免每次重渲染都重新计算

### 2. 类型安全
`divination.ts` 第48行:
建议为函数返回值添加明确的类型定义

## 建议改进

### 1. 代码可读性
`utils.ts` 第100行:
建议将复杂逻辑提取为独立函数，并添加注释

### 2. 命名建议
`api.ts` 第30行:
`getData` 建议改为更具体的名称如 `fetchUserProfile`
```

---

## 4. API设计规范

### 4.1 RESTful规范

#### URL设计

```
# ✅ 推荐: 使用名词复数
GET    /api/v1/users          # 获取用户列表
GET    /api/v1/users/:id      # 获取单个用户
POST   /api/v1/users          # 创建用户
PUT    /api/v1/users/:id      # 更新用户
DELETE /api/v1/users/:id      # 删除用户

# ❌ 避免: 使用动词
GET    /api/v1/getUsers
POST   /api/v1/createUser
```

#### 版本控制

```
# API路径包含版本号
/api/v1/users
/api/v2/users

# 向后兼容的修改不升级版本
# 破坏性变更需要升级版本
```

---

### 4.2 响应格式

#### 成功响应

```json
{
  "success": true,
  "data": {
    "id": "123",
    "name": "张三"
  },
  "message": "操作成功",
  "timestamp": 1704960000000
}
```

#### 错误响应

```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "用户不存在",
    "details": {
      "userId": "123"
    }
  },
  "timestamp": 1704960000000
}
```

#### 分页响应

```json
{
  "success": true,
  "data": {
    "items": [...],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

---

### 4.3 HTTP状态码

```
200 OK              # 成功
201 Created         # 创建成功
204 No Content      # 删除成功

400 Bad Request     # 请求参数错误
401 Unauthorized    # 未授权
403 Forbidden       # 无权限
404 Not Found       # 资源不存在
422 Unprocessable Entity # 验证失败

429 Too Many Requests # 请求过多

500 Internal Server Error # 服务器错误
503 Service Unavailable  # 服务不可用
```

---

## 5. 测试规范

### 5.1 单元测试

#### Jest测试

```typescript
// user.utils.test.ts
import { formatUserName, validateEmail } from './user.utils';

describe('formatUserName', () => {
  it('应该正确格式化用户名', () => {
    expect(formatUserName('张', '三')).toBe('张三');
  });

  it('应该处理缺失的姓氏', () => {
    expect(formatUserName('', '三')).toBe('三');
  });
});

describe('validateEmail', () => {
  it('应该验证有效的邮箱', () => {
    expect(validateEmail('test@example.com')).toBe(true);
  });

  it('应该拒绝无效的邮箱', () => {
    expect(validateEmail('invalid')).toBe(false);
  });
});
```

---

### 5.2 集成测试

```typescript
// api.test.ts
import { request } from './test-setup';

describe('POST /api/v1/users', () => {
  it('应该创建新用户', async () => {
    const response = await request(app)
      .post('/api/v1/users')
      .send({
        phoneNumber: '13800138000',
        nickname: '测试用户'
      });

    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
    expect(response.body.data.phoneNumber).toBe('13800138000');
  });

  it('应该拒绝重复的手机号', async () => {
    const response = await request(app)
      .post('/api/v1/users')
      .send({
        phoneNumber: '13800138000',
        nickname: '另一个用户'
      });

    expect(response.status).toBe(409);
    expect(response.body.error.code).toBe('PHONE_EXISTS');
  });
});
```

---

### 5.3 测试覆盖率

```
目标覆盖率:
- 语句覆盖率: > 80%
- 分支覆盖率: > 75%
- 函数覆盖率: > 80%
- 行覆盖率: > 80%

命令:
npm run test:coverage
```

---

## 6. 文档规范

### 6.1 代码注释

#### 函数注释

```typescript
/**
 * 格式化用户名称
 * @param lastName - 姓
 * @param firstName - 名
 * @returns 完整的用户名称
 * @example
 * ```ts
 * formatUserName('张', '三') // 返回 '张三'
 * ```
 */
export const formatUserName = (lastName: string, firstName: string): string => {
  if (!lastName) return firstName;
  if (!firstName) return lastName;
  return `${lastName}${firstName}`;
};
```

#### 复杂逻辑注释

```typescript
// ✅ 推荐: 解释"为什么"而非"是什么"
// 使用二分查找快速定位用户，时间复杂度O(log n)
const user = findUserBinarySearch(users, targetId);

// ❌ 避免: 重复代码逻辑
// i加1
i = i + 1;
```

---

### 6.2 README文档

```markdown
# 项目名称

## 简介
简短描述项目

## 安装
\`\`\`bash
npm install
\`\`\`

## 运行
\`\`\`bash
npm run dev
\`\`\`

## 测试
\`\`\`bash
npm test
\`\`\`

## 项目结构
\`\`\`
src/
├── components/
├── utils/
└── types/
\`\`\`

## 贡献指南
[如何贡献]

## 许可证
MIT
```

---

## 7. 性能优化规范

### 7.1 React性能

```typescript
// ✅ 推荐: 使用React.memo避免不必要的重渲染
const UserProfile = React.memo<Props>(({ user }) => {
  return <div>{user.name}</div>;
});

// ✅ 推荐: 使用useMemo缓存计算结果
const expensiveValue = useMemo(() => {
  return computeExpensiveValue(a, b);
}, [a, b]);

// ✅ 推荐: 使用useCallback缓存函数
const handleClick = useCallback(() => {
  doSomething(a, b);
}, [a, b]);

// ❌ 避免: 在渲染中创建新对象/数组
<Component style={{ color: 'red' }} /> // 每次渲染创建新对象
// ✅ 改为
const style = { color: 'red' };
<Component style={style} />
```

---

### 7.2 列表渲染优化

```typescript
// ✅ 推荐: 使用key
{users.map(user => (
  <UserItem key={user.id} user={user} />
))}

// ✅ 推荐: 大列表使用虚拟化
import { FlatList } from 'react-native';

<FlatList
  data={users}
  renderItem={({ item }) => <UserItem user={item} />}
  keyExtractor={item => item.id}
/>
```

---

## 8. 安全规范

### 8.1 敏感信息处理

```typescript
// ✅ 推荐: 敏感信息加密存储
const encryptedPhone = encrypt(phoneNumber);

// ✅ 推荐: 日志中脱敏
console.log(`用户手机: ${maskPhone(phone)}`); // 138****8000

// ❌ 避免: 日志中记录敏感信息
console.log(`用户密码: ${password}`); // 绝对不要!
```

---

### 8.2 输入验证

```typescript
// ✅ 推荐: 验证所有用户输入
const validateInput = (input: string): boolean => {
  // 长度检查
  if (input.length > 100) return false;
  // 特殊字符检查
  if (/[<>\"']/.test(input)) return false;
  return true;
};

// ✅ 推荐: 使用参数化查询防止SQL/NoSQL注入
const user = await User.findOne({ _id: ObjectId(userId) });
```

---

**文档编写**: Claude
**最后更新**: 2026-01-11
**审查周期**: 每季度审查更新
